From 8db5d26828fe95aefe26fedb4f9537df3799f9c1 Mon Sep 17 00:00:00 2001
From: Krzysztof Chojnowski <krzysiek@embedev.pl>
Date: Thu, 9 Apr 2020 19:19:13 +0200
Subject: [PATCH] Disable the display before transition to kernel

---
 arch/arm/dts/somlabs-visionsom-6ull.dts       |  4 ++--
 board/somlabs/visionsom-6ull/visionsom-6ull.c | 16 ++++------------
 drivers/video/mxsfb.c                         |  3 +++
 3 files changed, 9 insertions(+), 14 deletions(-)

diff --git a/arch/arm/dts/somlabs-visionsom-6ull.dts b/arch/arm/dts/somlabs-visionsom-6ull.dts
index c427ef3cf8..e2326b762c 100644
--- a/arch/arm/dts/somlabs-visionsom-6ull.dts
+++ b/arch/arm/dts/somlabs-visionsom-6ull.dts
@@ -285,9 +285,9 @@
 				MX6UL_PAD_LCD_HSYNC__LCDIF_HSYNC    0x79
 				MX6UL_PAD_LCD_VSYNC__LCDIF_VSYNC    0x79
 				/* used for lcd reset */
-				MX6UL_PAD_LCD_RESET__GPIO3_IO04     0x79
+				MX6UL_PAD_LCD_RESET__GPIO3_IO04     0x17099
 				/* used for LCD power on */
-				MX6UL_PAD_JTAG_TRST_B__GPIO1_IO15   0x79
+				MX6UL_PAD_JTAG_TRST_B__GPIO1_IO15   0x17099
 			>;
 		};
 
diff --git a/board/somlabs/visionsom-6ull/visionsom-6ull.c b/board/somlabs/visionsom-6ull/visionsom-6ull.c
index cd8d7b7f6f..fe7f6a6fc4 100644
--- a/board/somlabs/visionsom-6ull/visionsom-6ull.c
+++ b/board/somlabs/visionsom-6ull/visionsom-6ull.c
@@ -221,11 +221,7 @@ static iomux_v3_cfg_t const lcd_pads[] = {
 	MX6_PAD_LCD_DATA22__LCDIF_DATA22 | MUX_PAD_CTRL(LCD_PAD_CTRL),
 	MX6_PAD_LCD_DATA23__LCDIF_DATA23 | MUX_PAD_CTRL(LCD_PAD_CTRL),
 
-	/* LCD_RST */
-//	MX6_PAD_SNVS_TAMPER9__GPIO5_IO09 | MUX_PAD_CTRL(NO_PAD_CTRL),
-
-	/* Use GPIO for Brightness adjustment, duty cycle = period. */
-	MX6_PAD_GPIO1_IO08__GPIO1_IO08 | MUX_PAD_CTRL(NO_PAD_CTRL),
+	MX6_PAD_JTAG_TRST_B__GPIO1_IO15 | MUX_PAD_CTRL(NO_PAD_CTRL),
 };
 
 void do_enable_parallel_lcd(struct display_info_t const *dev)
@@ -235,14 +231,10 @@ void do_enable_parallel_lcd(struct display_info_t const *dev)
 	imx_iomux_v3_setup_multiple_pads(lcd_pads, ARRAY_SIZE(lcd_pads));
 
 	/* Reset the LCD */
-	gpio_request(IMX_GPIO_NR(5, 9), "lcd reset");
-	gpio_direction_output(IMX_GPIO_NR(5, 9) , 0);
+	gpio_request(IMX_GPIO_NR(1, 15), "lcd reset");
+	gpio_direction_output(IMX_GPIO_NR(1, 15) , 0);
 	udelay(500);
-	gpio_direction_output(IMX_GPIO_NR(5, 9) , 1);
-
-	/* Set Brightness to high */
-	gpio_request(IMX_GPIO_NR(1, 8), "backlight");
-	gpio_direction_output(IMX_GPIO_NR(1, 8) , 1);
+	gpio_direction_output(IMX_GPIO_NR(1, 15) , 1);
 }
 
 struct display_info_t const displays[] = {{
diff --git a/drivers/video/mxsfb.c b/drivers/video/mxsfb.c
index 838c037e5b..7ca64fcfda 100644
--- a/drivers/video/mxsfb.c
+++ b/drivers/video/mxsfb.c
@@ -184,6 +184,9 @@ static void mxs_lcd_init(GraphicDevice *panel,
 
 void lcdif_power_down(void)
 {
+	// Disable the display backlight
+	gpio_set_value(IMX_GPIO_NR(1, 15), 0);
+
 	struct mxs_lcdif_regs *regs = (struct mxs_lcdif_regs *)(ulong)(panel.isaBase);
 	int timeout = 1000000;
 
